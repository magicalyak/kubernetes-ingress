# configuration for default/cafe-ingress

# Start OIDC Customization

# Custom log format to include the 'sub' claim in the REMOTE_USER field
log_format main_jwt '$remote_addr - $jwt_claim_sub [$time_local] "$request" $status '
                    '$body_bytes_sent "$http_referer" "$http_user_agent" "$http_x_forwarded_for"';

map $jwt_claim_preferred_username $jwt_nibr521 {
    default $jwt_claim_preferred_username;
    ~^(?<username>.*)@(?<domain>.*)$ "${username}";
}
# End OIDC Customization


upstream default-cafe-ingress-cafe.nginx.net-coffee-svc-80 {
    zone default-cafe-ingress-cafe.nginx.net-coffee-svc-80 256k;
    random two least_conn;
    
    server 10.233.92.144:8080 max_fails=1 fail_timeout=10s max_conns=0;
    server 10.233.96.189:8080 max_fails=1 fail_timeout=10s max_conns=0;
    
    
}
upstream default-cafe-ingress-cafe.nginx.net-tea-svc-80 {
    zone default-cafe-ingress-cafe.nginx.net-tea-svc-80 256k;
    random two least_conn;
    
    server 10.233.92.142:8080 max_fails=1 fail_timeout=10s max_conns=0;
    server 10.233.92.143:8080 max_fails=1 fail_timeout=10s max_conns=0;
    server 10.233.96.188:8080 max_fails=1 fail_timeout=10s max_conns=0;
    
    
}


server {
    
    
    listen 80;
    

    
    
    listen 443 ssl;
    
    ssl_certificate /etc/nginx/secrets/default-cafe-secret;
    ssl_certificate_key /etc/nginx/secrets/default-cafe-secret;
    
    

    
    
    

    server_tokens "on";

    server_name cafe.nginx.net;

    status_zone cafe.nginx.net;

    
    
    
    

    
    
    if ($scheme = http) {
        return 301 https://$host:443$request_uri;
    }
    

    
    
    # Start OIDC Customization
    include conf.d/openid_connect.server_conf; # Authorization code flow and Relying Party processing
    {{- $oidc_jwt_keyfile := index $.Ingress.Annotations "custom.nginx.org/oidc-jwt-keyfile"}}
    {{- $oidc_logout_redirect := index $.Ingress.Annotations "custom.nginx.org/oidc-logout-redirect"}}
    {{- $oidc_authz_endpoint := index $.Ingress.Annotations "custom.nginx.org/oidc-authz-endpoint"}}
    {{- $oidc_token_endpoint := index $.Ingress.Annotations "custom.nginx.org/oidc-token-endpoint"}}
    {{- $oidc_client := index $.Ingress.Annotations "custom.nginx.org/oidc-client"}}
    {{- $oidc_client_secret := index $.Ingress.Annotations "custom.nginx.org/oidc-client-secret"}}
    {{ $oidc_hmac_key := index $.Ingress.Annotations "custom.nginx.org/oidc-hmac-key"}}
    set $oidc_jwt_keyfile "{{$oidc_jwt_keyfile}}";
    set $oidc_logout_redirect "{{$oidc_logout_redirect}}";
    set $oidc_authz_endpoint "{{$oidc_authz_endpoint}}";
    set $oidc_token_endpoint "{{$oidc_token_endpoint}}";
    set $oidc_client "{{$oidc_client}}";
    set $oidc_client_secret "{{$oidc_client_secret}}";
    set $oidc_hmac_key "{{$oidc_hmac_key}}";
    
    location /tea {
        
        
        proxy_http_version 1.1;
        

        

        # Start OIDC Customization
        auth_jwt "" token=$session_jwt;
        error_page 401 = @do_oidc_flow;

        #auth_jwt_key_file $oidc_jwt_keyfile;
        auth_jwt_key_request /_jwks_uri;

        proxy_set_header username $jwt_claim_sub;
        proxy_set_header jwt-email $jwt_claim_email;
        proxy_set_header jwt-username $jwt_claim_preferred_username;
        proxy_set_header jwt-name $jwt_claim_name;
        proxy_set_header jwt-aud $jwt_claim_aud;
        proxy_set_header jwt-azp $jwt_claim_azp;
        proxy_set_header jwt-email-verified $jwt_claim_email_verified;
        proxy_set_header jwt-firstname $jwt_claim_given_name;
        proxy_set_header jwt-lastname $jwt_claim_family_name;
        proxy_set_header jwt-acr $jwt_claim_acr;
        proxy_set_header jwt-typ $jwt_claim_typ;
        proxy_set_header jwt-nibr521 $jwt_nibr521;

        access_log /var/log/nginx/access.log main_jwt;
        # End OIDC Customization

        proxy_connect_timeout 60s;
        proxy_read_timeout 60s;
        proxy_send_timeout 60s;
        client_max_body_size 1m;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffering on;
        
        
        proxy_pass http://default-cafe-ingress-cafe.nginx.net-tea-svc-80;
        
        
    }
    location /coffee {
        
        
        proxy_http_version 1.1;
        

        

        # Start OIDC Customization
        auth_jwt "" token=$session_jwt;
        error_page 401 = @do_oidc_flow;

        #auth_jwt_key_file $oidc_jwt_keyfile;
        auth_jwt_key_request /_jwks_uri;

        proxy_set_header username $jwt_claim_sub;
        proxy_set_header jwt-email $jwt_claim_email;
        proxy_set_header jwt-username $jwt_claim_preferred_username;
        proxy_set_header jwt-name $jwt_claim_name;
        proxy_set_header jwt-aud $jwt_claim_aud;
        proxy_set_header jwt-azp $jwt_claim_azp;
        proxy_set_header jwt-email-verified $jwt_claim_email_verified;
        proxy_set_header jwt-firstname $jwt_claim_given_name;
        proxy_set_header jwt-lastname $jwt_claim_family_name;
        proxy_set_header jwt-acr $jwt_claim_acr;
        proxy_set_header jwt-typ $jwt_claim_typ;
        proxy_set_header jwt-nibr521 $jwt_nibr521;

        access_log /var/log/nginx/access.log main_jwt;
        # End OIDC Customization

        proxy_connect_timeout 60s;
        proxy_read_timeout 60s;
        proxy_send_timeout 60s;
        client_max_body_size 1m;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffering on;
        
        
        proxy_pass http://default-cafe-ingress-cafe.nginx.net-coffee-svc-80;
        
        
    }
    
    
}
